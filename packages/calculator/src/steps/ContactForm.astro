---
/**
 * ContactForm - Final Step Lead Capture
 *
 * Personal data collection form - ONLY for final calculator step.
 * Includes GDPR consent checkbox.
 */

export interface Props {
  /** Form name prefix */
  name?: string;
  /** Show phone field */
  showPhone?: boolean;
  /** Show company field */
  showCompany?: boolean;
  /** Show message field */
  showMessage?: boolean;
  /** Privacy policy URL */
  privacyUrl?: string;
  /** Submit button text */
  submitText?: string;
  /** Additional classes */
  class?: string;
}

const {
  name = 'contact',
  showPhone = true,
  showCompany = false,
  showMessage = false,
  privacyUrl = '/adatvedelmi-tajekoztato',
  submitText = 'Árajánlat kérése',
  class: className,
} = Astro.props;
---

<div class:list={['contact-form', className]} data-contact-form>
  <div class="space-y-6">
    {/* Name field */}
    <div>
      <label for={`${name}_name`} class="block text-sm font-medium text-gray-700 mb-1">
        Név <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id={`${name}_name`}
        name={`${name}_name`}
        required
        autocomplete="name"
        placeholder="Teljes név"
        class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
      />
    </div>

    {/* Email field */}
    <div>
      <label for={`${name}_email`} class="block text-sm font-medium text-gray-700 mb-1">
        Email <span class="text-red-500">*</span>
      </label>
      <input
        type="email"
        id={`${name}_email`}
        name={`${name}_email`}
        required
        autocomplete="email"
        placeholder="pelda@email.hu"
        class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
      />
    </div>

    {/* Phone field */}
    {showPhone && (
      <div>
        <label for={`${name}_phone`} class="block text-sm font-medium text-gray-700 mb-1">
          Telefon <span class="text-red-500">*</span>
        </label>
        <input
          type="tel"
          id={`${name}_phone`}
          name={`${name}_phone`}
          required
          autocomplete="tel"
          placeholder="+36 30 123 4567"
          class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
        />
      </div>
    )}

    {/* Company field */}
    {showCompany && (
      <div>
        <label for={`${name}_company`} class="block text-sm font-medium text-gray-700 mb-1">
          Cégnév
        </label>
        <input
          type="text"
          id={`${name}_company`}
          name={`${name}_company`}
          autocomplete="organization"
          placeholder="Cég neve (opcionális)"
          class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
        />
      </div>
    )}

    {/* Message field */}
    {showMessage && (
      <div>
        <label for={`${name}_message`} class="block text-sm font-medium text-gray-700 mb-1">
          Megjegyzés
        </label>
        <textarea
          id={`${name}_message`}
          name={`${name}_message`}
          rows={3}
          placeholder="További információk (opcionális)"
          class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none"
        />
      </div>
    )}

    {/* GDPR consent */}
    <div class="flex items-start gap-3">
      <input
        type="checkbox"
        id={`${name}_gdpr`}
        name={`${name}_gdpr`}
        required
        class="mt-1 h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
      />
      <label for={`${name}_gdpr`} class="text-sm text-gray-600">
        Elolvastam és elfogadom az{' '}
        <a
          href={privacyUrl}
          target="_blank"
          rel="noopener"
          class="text-primary-600 hover:text-primary-700 underline"
        >
          Adatvédelmi tájékoztatót
        </a>
        . <span class="text-red-500">*</span>
      </label>
    </div>

    {/* Submit button */}
    <button
      type="submit"
      data-submit-button
      class="w-full py-4 px-6 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition-colors focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span data-button-text>{submitText}</span>
      <span data-button-loading class="hidden">
        <svg class="inline-block w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" />
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
        </svg>
        Küldés...
      </span>
    </button>

    {/* Error message */}
    <div data-form-error class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
      <p class="text-sm text-red-600">
        Hiba történt a küldés során. Kérjük, próbálja újra.
      </p>
    </div>
  </div>
</div>

<script>
  function initContactForms() {
    document.querySelectorAll<HTMLDivElement>('[data-contact-form]').forEach((container) => {
      const form = container.closest('form');
      if (!form) return;

      const submitButton = container.querySelector<HTMLButtonElement>('[data-submit-button]');
      const buttonText = container.querySelector<HTMLSpanElement>('[data-button-text]');
      const buttonLoading = container.querySelector<HTMLSpanElement>('[data-button-loading]');
      const formError = container.querySelector<HTMLDivElement>('[data-form-error]');

      // Phone formatting
      const phoneInput = container.querySelector<HTMLInputElement>('input[type="tel"]');
      if (phoneInput) {
        phoneInput.addEventListener('input', () => {
          let value = phoneInput.value.replace(/\D/g, '');

          // Format as +36 XX XXX XXXX
          if (value.length > 0) {
            if (!value.startsWith('36') && !value.startsWith('+')) {
              value = '36' + value;
            }
            value = value.replace(/^36/, '+36 ');

            if (value.length > 7) {
              value = value.slice(0, 7) + ' ' + value.slice(7);
            }
            if (value.length > 11) {
              value = value.slice(0, 11) + ' ' + value.slice(11);
            }
          }

          phoneInput.value = value.slice(0, 16);
        });
      }

      // Helper to reset form state
      function resetFormState() {
        if (submitButton && buttonText && buttonLoading) {
          submitButton.disabled = false;
          buttonText.classList.remove('hidden');
          buttonLoading.classList.add('hidden');
        }
      }

      // Form submission handling
      form.addEventListener('submit', async (e) => {
        // Let the parent handle submission, just show loading state
        if (submitButton && buttonText && buttonLoading) {
          submitButton.disabled = true;
          buttonText.classList.add('hidden');
          buttonLoading.classList.remove('hidden');
        }

        formError?.classList.add('hidden');
      });

      // Listen for custom error/complete events from parent
      form.addEventListener('form:error', () => {
        resetFormState();
        formError?.classList.remove('hidden');
      });

      form.addEventListener('form:success', () => {
        resetFormState();
      });

      // Also reset after timeout (safety net)
      form.addEventListener('submit', () => {
        setTimeout(() => {
          // If still loading after 30s, reset (something went wrong)
          if (submitButton?.disabled) {
            resetFormState();
            formError?.classList.remove('hidden');
          }
        }, 30000);
      });
    });
  }

  // Init on load
  initContactForms();

  // Re-init on navigation
  document.addEventListener('astro:page-load', initContactForms);
</script>
