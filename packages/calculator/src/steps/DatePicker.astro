---
/**
 * DatePicker - Date Selection Component
 *
 * Date input with optional weekend pricing indicator.
 */

export interface Props {
  /** Input name */
  name: string;
  /** Selected date (ISO format) */
  value?: string;
  /** Minimum date (ISO format or 'today') */
  min?: string;
  /** Maximum date (ISO format) */
  max?: string;
  /** Label */
  label?: string;
  /** Help text */
  help?: string;
  /** Required field */
  required?: boolean;
  /** Show weekend indicator */
  showWeekendIndicator?: boolean;
  /** Weekend surcharge percentage */
  weekendSurcharge?: number;
  /** Additional classes */
  class?: string;
}

const {
  name,
  value,
  min = 'today',
  max,
  label,
  help,
  required = false,
  showWeekendIndicator = true,
  weekendSurcharge,
  class: className,
} = Astro.props;

// Calculate min date
const minDate = min === 'today'
  ? new Date().toISOString().split('T')[0]
  : min;
---

<div class:list={['date-picker', className]} data-date-picker>
  {label && (
    <label for={name} class="block text-sm font-medium text-gray-700 mb-2">
      {label}
      {required && <span class="text-red-500 ml-1">*</span>}
    </label>
  )}

  <div class="relative">
    <input
      type="date"
      id={name}
      name={name}
      value={value}
      min={minDate}
      max={max}
      required={required}
      data-date-input
      class="block w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
    />
  </div>

  {/* Weekend indicator */}
  {showWeekendIndicator && (
    <div
      data-weekend-indicator
      class="hidden mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg"
    >
      <div class="flex items-center gap-2 text-amber-800">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span class="text-sm">
          Hétvégi időpont
          {weekendSurcharge && (
            <span class="font-medium"> (+{weekendSurcharge}% felár)</span>
          )}
        </span>
      </div>
    </div>
  )}

  {/* Selected date display */}
  <div data-date-display class="hidden mt-3 text-center">
    <p class="text-lg font-medium text-gray-900" data-formatted-date></p>
    <p class="text-sm text-gray-500" data-day-name></p>
  </div>

  {help && (
    <p class="mt-2 text-sm text-gray-500">{help}</p>
  )}
</div>

<script>
  const dayNames = [
    'Vasárnap',
    'Hétfő',
    'Kedd',
    'Szerda',
    'Csütörtök',
    'Péntek',
    'Szombat',
  ];

  const monthNames = [
    'január',
    'február',
    'március',
    'április',
    'május',
    'június',
    'július',
    'augusztus',
    'szeptember',
    'október',
    'november',
    'december',
  ];

  function initDatePickers() {
    document.querySelectorAll<HTMLDivElement>('[data-date-picker]').forEach((container) => {
      const input = container.querySelector<HTMLInputElement>('[data-date-input]');
      const weekendIndicator = container.querySelector<HTMLDivElement>('[data-weekend-indicator]');
      const dateDisplay = container.querySelector<HTMLDivElement>('[data-date-display]');
      const formattedDate = container.querySelector<HTMLParagraphElement>('[data-formatted-date]');
      const dayName = container.querySelector<HTMLParagraphElement>('[data-day-name]');

      if (!input) return;

      input.addEventListener('change', () => {
        const value = input.value;

        if (!value) {
          weekendIndicator?.classList.add('hidden');
          dateDisplay?.classList.add('hidden');
          return;
        }

        const date = new Date(value + 'T12:00:00');
        const dayOfWeek = date.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

        // Toggle weekend indicator
        if (weekendIndicator) {
          weekendIndicator.classList.toggle('hidden', !isWeekend);
        }

        // Update date display
        if (dateDisplay && formattedDate && dayName) {
          const formatted = `${date.getFullYear()}. ${monthNames[date.getMonth()]} ${date.getDate()}.`;
          formattedDate.textContent = formatted;
          dayName.textContent = dayNames[dayOfWeek];
          dateDisplay.classList.remove('hidden');
        }

        // Store weekend flag in data attribute
        input.dataset.isWeekend = isWeekend ? 'true' : 'false';
      });

      // Trigger change if value already set
      if (input.value) {
        input.dispatchEvent(new Event('change'));
      }
    });
  }

  // Init on load
  initDatePickers();

  // Re-init on navigation
  document.addEventListener('astro:page-load', initDatePickers);
</script>
