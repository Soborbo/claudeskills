---
/**
 * ContactForm Component
 *
 * Lead generation form with spam protection, validation, and GDPR compliance.
 * Requires server-side API endpoint for processing.
 *
 * @example
 * <ContactForm
 *   action="/api/contact"
 *   turnstileSiteKey={import.meta.env.PUBLIC_TURNSTILE_SITE_KEY}
 *   thankYouUrl="/koszonjuk"
 *   privacyPolicyUrl="/adatvedelem"
 * />
 *
 * Features:
 * - Honeypot field (spam trap)
 * - Form start time tracking (prevents bot speed)
 * - Turnstile CAPTCHA integration
 * - GDPR consent with timestamp
 * - Client-side validation
 * - GA4 form_submit event
 * - Accessible error messages
 */

export interface Props {
  /** Form submission endpoint */
  action: string;

  /** Cloudflare Turnstile site key */
  turnstileSiteKey: string;

  /** Redirect URL after successful submission */
  thankYouUrl: string;

  /** Privacy policy page URL */
  privacyPolicyUrl: string;

  /** Form title */
  title?: string;

  /** Form description */
  description?: string;

  /** Submit button text */
  submitText?: string;

  /** Loading state text */
  loadingText?: string;

  /** Show phone field */
  showPhone?: boolean;

  /** Show message field */
  showMessage?: boolean;

  /** Enable file upload field */
  showFileUpload?: boolean;

  /** Accepted file types for upload */
  acceptedFileTypes?: string;

  /** Max file size in MB */
  maxFileSizeMB?: number;

  /** File upload label */
  fileUploadLabel?: string;

  /** Rate limit: max submissions per session */
  maxSubmissionsPerSession?: number;

  /** Rate limit warning text */
  rateLimitText?: string;

  /** Additional CSS classes */
  class?: string;

  /** Form ID for analytics */
  formId?: string;
}

const {
  action,
  turnstileSiteKey,
  thankYouUrl,
  privacyPolicyUrl,
  title,
  description,
  submitText = 'Küldés',
  loadingText = 'Küldés...',
  showPhone = true,
  showMessage = true,
  showFileUpload = false,
  acceptedFileTypes = '.pdf,.doc,.docx,.jpg,.jpeg,.png',
  maxFileSizeMB = 5,
  fileUploadLabel = 'Fájl csatolása',
  maxSubmissionsPerSession = 3,
  rateLimitText = 'Elérte a maximális küldésszámot. Kérjük, próbálja később.',
  class: className,
  formId = 'contact-form',
} = Astro.props;

const currentUrl = Astro.url.href;
---

<div class:list={['contact-form-wrapper', className]}>
  {title && (
    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">{title}</h2>
  )}
  {description && (
    <p class="text-gray-600 mb-6">{description}</p>
  )}

  <form
    id={formId}
    action={action}
    method="POST"
    class="space-y-5"
    novalidate
    data-thank-you-url={thankYouUrl}
    data-max-submissions={maxSubmissionsPerSession}
    data-rate-limit-text={rateLimitText}
  >
    <!-- Honeypot (spam trap - must stay empty) -->
    <div class="hidden" aria-hidden="true">
      <label for="website">Website</label>
      <input
        type="text"
        id="website"
        name="honeypot"
        tabindex="-1"
        autocomplete="off"
      />
    </div>

    <!-- Form start time (bot speed detection) -->
    <input type="hidden" name="formStartTime" id="formStartTime" />

    <!-- Source URL for tracking -->
    <input type="hidden" name="sourceUrl" value={currentUrl} />

    <!-- UTM params (populated by script) -->
    <input type="hidden" name="utmSource" id="utmSource" />
    <input type="hidden" name="utmMedium" id="utmMedium" />
    <input type="hidden" name="utmCampaign" id="utmCampaign" />

    <!-- Name -->
    <div>
      <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
        Név <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        id="name"
        name="name"
        required
        minlength="2"
        autocomplete="name"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
        aria-describedby="name-error"
      />
      <p id="name-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
    </div>

    <!-- Email -->
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
        Email <span class="text-red-500">*</span>
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        autocomplete="email"
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
        aria-describedby="email-error"
      />
      <p id="email-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
    </div>

    <!-- Phone (optional) -->
    {showPhone && (
      <div>
        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">
          Telefon <span class="text-red-500">*</span>
        </label>
        <input
          type="tel"
          id="phone"
          name="phone"
          required
          autocomplete="tel"
          placeholder="+36 20 123 4567"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
          aria-describedby="phone-error"
        />
        <p id="phone-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
      </div>
    )}

    <!-- Message (optional) -->
    {showMessage && (
      <div>
        <label for="message" class="block text-sm font-medium text-gray-700 mb-1">
          Üzenet
        </label>
        <textarea
          id="message"
          name="message"
          rows="4"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors resize-none"
          aria-describedby="message-error"
        ></textarea>
        <p id="message-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
      </div>
    )}

    <!-- File Upload (optional) -->
    {showFileUpload && (
      <div>
        <label for="file" class="block text-sm font-medium text-gray-700 mb-1">
          {fileUploadLabel}
        </label>
        <div class="relative">
          <input
            type="file"
            id="file"
            name="file"
            accept={acceptedFileTypes}
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100"
            aria-describedby="file-error file-hint"
            data-max-size-mb={maxFileSizeMB}
          />
        </div>
        <p id="file-hint" class="mt-1 text-xs text-gray-500">
          Max {maxFileSizeMB}MB. Elfogadott: {acceptedFileTypes}
        </p>
        <p id="file-error" class="mt-1 text-sm text-red-600 hidden" role="alert"></p>
      </div>
    )}

    <!-- GDPR Consent -->
    <div class="flex items-start gap-3">
      <input
        type="checkbox"
        id="gdprConsent"
        name="gdprConsent"
        required
        value="true"
        class="mt-1 w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
        aria-describedby="gdpr-error"
      />
      <label for="gdprConsent" class="text-sm text-gray-600">
        Elfogadom az <a href={privacyPolicyUrl} class="text-primary-600 hover:underline" target="_blank">adatvédelmi szabályzatot</a> <span class="text-red-500">*</span>
      </label>
    </div>
    <input type="hidden" name="gdprTimestamp" id="gdprTimestamp" />
    <p id="gdpr-error" class="text-sm text-red-600 hidden" role="alert"></p>

    <!-- Turnstile CAPTCHA -->
    <div
      class="cf-turnstile"
      data-sitekey={turnstileSiteKey}
      data-theme="light"
      data-size="flexible"
    ></div>
    <p id="turnstile-error" class="text-sm text-red-600 hidden" role="alert"></p>

    <!-- General Error Message -->
    <div id="form-error" class="p-4 bg-red-50 border border-red-200 rounded-lg hidden" role="alert">
      <p class="text-sm text-red-700"></p>
    </div>

    <!-- Submit Button -->
    <button
      type="submit"
      class="w-full px-6 py-4 bg-primary-600 text-white font-semibold rounded-lg hover:bg-primary-700 focus:ring-4 focus:ring-primary-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
      data-submit-text={submitText}
      data-loading-text={loadingText}
    >
      {submitText}
    </button>
  </form>
</div>

<!-- Turnstile Script -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
  // UTM localStorage helpers
  const UTM_STORAGE_KEY = 'leadgen_utm_params';

  function saveUtmToStorage(params: Record<string, string>) {
    try {
      const existing = JSON.parse(localStorage.getItem(UTM_STORAGE_KEY) || '{}');
      const merged = { ...existing, ...params, timestamp: Date.now() };
      localStorage.setItem(UTM_STORAGE_KEY, JSON.stringify(merged));
    } catch (e) {
      // localStorage not available
    }
  }

  function getUtmFromStorage(): Record<string, string> {
    try {
      const stored = localStorage.getItem(UTM_STORAGE_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        // Expire after 30 days
        if (data.timestamp && Date.now() - data.timestamp < 30 * 24 * 60 * 60 * 1000) {
          return data;
        }
      }
    } catch (e) {
      // localStorage not available
    }
    return {};
  }

  // Rate limiting helpers
  const SUBMISSION_KEY = 'leadgen_form_submissions';

  function getSubmissionCount(): number {
    try {
      const stored = sessionStorage.getItem(SUBMISSION_KEY);
      return stored ? parseInt(stored, 10) : 0;
    } catch (e) {
      return 0;
    }
  }

  function incrementSubmissionCount(): void {
    try {
      const current = getSubmissionCount();
      sessionStorage.setItem(SUBMISSION_KEY, (current + 1).toString());
    } catch (e) {
      // sessionStorage not available
    }
  }

  function initContactForm() {
    const forms = document.querySelectorAll('form[id^="contact-form"]');

    forms.forEach((form) => {
      const formEl = form as HTMLFormElement;

      // Prevent re-initialization
      if (formEl.dataset.initialized) return;
      formEl.dataset.initialized = 'true';

      // Set form start time
      const startTimeInput = formEl.querySelector('#formStartTime') as HTMLInputElement;
      if (startTimeInput) {
        startTimeInput.value = Date.now().toString();
      }

      // UTM handling: URL params take priority, fallback to localStorage
      const urlParams = new URLSearchParams(window.location.search);
      const storedUtm = getUtmFromStorage();

      const utmSource = formEl.querySelector('#utmSource') as HTMLInputElement;
      const utmMedium = formEl.querySelector('#utmMedium') as HTMLInputElement;
      const utmCampaign = formEl.querySelector('#utmCampaign') as HTMLInputElement;

      // Get UTM values with URL priority, localStorage fallback
      const utmValues = {
        utm_source: urlParams.get('utm_source') || storedUtm.utm_source || '',
        utm_medium: urlParams.get('utm_medium') || storedUtm.utm_medium || '',
        utm_campaign: urlParams.get('utm_campaign') || storedUtm.utm_campaign || '',
      };

      // Set form values
      if (utmSource) utmSource.value = utmValues.utm_source;
      if (utmMedium) utmMedium.value = utmValues.utm_medium;
      if (utmCampaign) utmCampaign.value = utmValues.utm_campaign;

      // Save UTM to localStorage if found in URL
      if (urlParams.get('utm_source') || urlParams.get('utm_medium') || urlParams.get('utm_campaign')) {
        saveUtmToStorage(utmValues);
      }

      // GDPR timestamp on check
      const gdprCheckbox = formEl.querySelector('#gdprConsent') as HTMLInputElement;
      const gdprTimestamp = formEl.querySelector('#gdprTimestamp') as HTMLInputElement;

      gdprCheckbox?.addEventListener('change', () => {
        if (gdprCheckbox.checked && gdprTimestamp) {
          gdprTimestamp.value = new Date().toISOString();
        }
      });

      // File upload validation
      const fileInput = formEl.querySelector('#file') as HTMLInputElement;
      if (fileInput) {
        fileInput.addEventListener('change', () => {
          const file = fileInput.files?.[0];
          const errorEl = formEl.querySelector('#file-error');
          const maxSizeMB = parseInt(fileInput.dataset.maxSizeMb || '5', 10);

          if (file && file.size > maxSizeMB * 1024 * 1024) {
            if (errorEl) {
              errorEl.textContent = `A fájl túl nagy. Maximum ${maxSizeMB}MB engedélyezett.`;
              errorEl.classList.remove('hidden');
            }
            fileInput.value = '';
          } else if (errorEl) {
            errorEl.classList.add('hidden');
          }
        });
      }

      // Form submission
      formEl.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement;
        const submitText = submitBtn.dataset.submitText || 'Küldés';
        const loadingText = submitBtn.dataset.loadingText || 'Küldés...';
        const thankYouUrl = formEl.dataset.thankYouUrl;
        const maxSubmissions = parseInt(formEl.dataset.maxSubmissions || '3', 10);
        const rateLimitText = formEl.dataset.rateLimitText || 'Túl sok küldés. Próbálja később.';

        // Check rate limit
        if (getSubmissionCount() >= maxSubmissions) {
          const formError = formEl.querySelector('#form-error');
          const errorText = formError?.querySelector('p');
          if (formError && errorText) {
            errorText.textContent = rateLimitText;
            formError.classList.remove('hidden');
          }
          return;
        }

        // Clear previous errors
        formEl.querySelectorAll('[role="alert"]').forEach((el) => {
          el.classList.add('hidden');
          el.textContent = '';
        });

        // Client-side validation
        const errors: Record<string, string> = {};

        const name = (formEl.querySelector('#name') as HTMLInputElement)?.value;
        const email = (formEl.querySelector('#email') as HTMLInputElement)?.value;
        const phone = (formEl.querySelector('#phone') as HTMLInputElement)?.value;
        const gdprConsent = (formEl.querySelector('#gdprConsent') as HTMLInputElement)?.checked;

        if (!name || name.length < 2) {
          errors.name = 'Kérjük, adja meg a nevét (min. 2 karakter)';
        }

        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          errors.email = 'Kérjük, adjon meg érvényes email címet';
        }

        if (phone !== undefined && (!phone || !/^(\+36|06)?[\s-]?[0-9]{1,2}[\s-]?[0-9]{3}[\s-]?[0-9]{3,4}$/.test(phone.replace(/\s/g, '')))) {
          errors.phone = 'Kérjük, adjon meg érvényes telefonszámot';
        }

        if (!gdprConsent) {
          errors.gdpr = 'Az adatvédelmi szabályzat elfogadása kötelező';
        }

        // Check Turnstile
        const turnstileResponse = (formEl.querySelector('[name="cf-turnstile-response"]') as HTMLInputElement)?.value;
        if (!turnstileResponse) {
          errors.turnstile = 'Kérjük, igazolja, hogy nem robot';
        }

        // File validation
        const fileInputEl = formEl.querySelector('#file') as HTMLInputElement;
        if (fileInputEl?.files?.[0]) {
          const maxSizeMB = parseInt(fileInputEl.dataset.maxSizeMb || '5', 10);
          if (fileInputEl.files[0].size > maxSizeMB * 1024 * 1024) {
            errors.file = `A fájl túl nagy. Maximum ${maxSizeMB}MB engedélyezett.`;
          }
        }

        // Show errors if any
        if (Object.keys(errors).length > 0) {
          Object.entries(errors).forEach(([field, message]) => {
            const errorEl = formEl.querySelector(`#${field}-error`);
            if (errorEl) {
              errorEl.textContent = message;
              errorEl.classList.remove('hidden');
            }
          });
          return;
        }

        // Submit
        try {
          submitBtn.disabled = true;
          submitBtn.textContent = loadingText;

          const formData = new FormData(formEl);

          // For file uploads, use FormData directly
          const hasFile = fileInputEl?.files?.[0];
          let response: Response;

          if (hasFile) {
            response = await fetch(formEl.action, {
              method: 'POST',
              body: formData,
            });
          } else {
            const data = Object.fromEntries(formData.entries());
            response = await fetch(formEl.action, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data),
            });
          }

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || 'Hiba történt az űrlap elküldésekor');
          }

          // Increment submission count on success
          incrementSubmissionCount();

          // GA4 Event
          if (typeof window !== 'undefined' && (window as any).dataLayer) {
            (window as any).dataLayer.push({
              event: 'form_submit',
              form_id: formEl.id,
              form_name: 'contact_form',
            });
          }

          // Redirect to thank you page
          if (thankYouUrl) {
            window.location.href = thankYouUrl;
          }
        } catch (error) {
          const formError = formEl.querySelector('#form-error');
          const errorText = formError?.querySelector('p');
          if (formError && errorText) {
            errorText.textContent = error instanceof Error ? error.message : 'Hiba történt. Kérjük, próbálja újra később.';
            formError.classList.remove('hidden');
          }

          submitBtn.disabled = false;
          submitBtn.textContent = submitText;
        }
      });
    });
  }

  initContactForm();
  document.addEventListener('astro:page-load', initContactForm);
</script>

<style>
  /* Turnstile responsive */
  .cf-turnstile {
    min-height: 65px;
  }
</style>
